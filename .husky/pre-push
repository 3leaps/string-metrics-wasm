#!/bin/sh

# string-metrics-wasm Pre-push Hook
# Full validation suite including tests and build verification

echo "ğŸš€ string-metrics-wasm Pre-push Validation..."

# 1. Version check
echo "ğŸ” Checking version sync..."
make version-check || {
  echo "âŒ Version mismatch between package.json and Cargo.toml. Please sync versions."
  exit 1
}

# 2. License compliance check
echo "ğŸ“œ Checking license compliance..."
npm run license:check || {
  echo "âŒ License check failed. Dependencies with GPL/LGPL/AGPL detected."
  echo "   Please replace with permissively-licensed alternatives."
  exit 1
}

# 3. Full quality checks
echo "âœ¨ Running quality checks..."
make quality || {
  echo "âŒ Quality checks failed. Please fix before pushing."
  echo ""
  echo "ğŸ’¡ Common fixes:"
  echo "   - Format issues: 'make format'"
  echo "   - Lint issues: 'make lint-fix'"
  echo "   - Rust issues: 'make rust-fmt && make rust-clippy'"
  exit 1
}

# 4. Build verification
echo "ğŸ”¨ Building WASM and TypeScript..."
make build || {
  echo "âŒ Build failed. Please fix before pushing."
  exit 1
}

# 5. Full test suite
echo "ğŸ§ª Running test suite..."
make test || {
  echo "âŒ Tests failed. Please fix before pushing."
  exit 1
}

# 6. Validate fixtures (if validator is built)
if [ -f "dist/similarity-validator" ]; then
  echo "ğŸ“‹ Validating fixtures..."
  make validate-fixtures || {
    echo "âš ï¸  Fixture validation failed. Please review fixture accuracy."
    # Don't fail on fixture validation - it's informational
  }
fi

echo "âœ… All pre-push checks passed!"
